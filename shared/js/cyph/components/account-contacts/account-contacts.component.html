<div
	fxFlexFill
	fxLayout="row"
	class="card-list animated slideInDown"
	[class.mobile]="envService.isMobile | await"
	[class.initiating]="
		(accountContactsService.showSpinner | await) ||
		(home && (accountFilesService.uploadSpinner | await) !== undefined)
	"
>
	<div fxFlex fxLayout="column" fxLayoutAlign="start stretch">
		<ng-container
			*ngIf="
				(accountDatabaseService.currentUser | await)?.pseudoAccount ===
				true
			"
		>
			<br />
			<br />
			<div fxFlex="48px" fxLayoutAlign="center">
				<cyph-logo
					alt
					homeLink
					[white]="!!envService.environment.customBuild?.config?.dark"
				></cyph-logo>
			</div>
		</ng-container>

		<br *ngIf="envService.isMobile | await" />

		<cyph-account-contacts-search
			#accountContactsSearch
			[class.searchMode]="searchMode"
			[autofocus]="searchMode"
			[contactList]="contactList"
			[externalUsers]="true"
			[searchProfileExtra]="searchProfileExtra"
			(searchBarBlur)="searchBarBlur.emit()"
			*ngIf="!readOnly"
		></cyph-account-contacts-search>

		<div
			fxFlex
			fxLayoutAlign="center center"
			*ngIf="
				youHaveNoFriends &&
					(accountContactsService.showSpinner | await) === false &&
					((contactList | await)?.length || 0) < 1;
				else mainContactListView
			"
		>
			<div>{{ stringsService.emptyContactList }}</div>
		</div>

		<ng-template #mainContactListView>
			<div>
				<cyph-account-contact
					class="active animated slideInDown"
					[class.cyph-inverted-theme]="invertedTheme"
					[contact]="
						accountContactsSearch?.searchBar?.filterSingle | await
					"
					[hideCurrentUser]="true"
					[showUnreadMessageCount]="true"
					(click)="accountContactsSearch?.searchBar?.clearFilter()"
					*ngIf="
						(accountContactsSearch?.searchBar?.filterSingle
							| await) !== undefined
					"
				></cyph-account-contact>

				<cyph-account-contact
					class="active animated slideInDown"
					[class.cyph-inverted-theme]="invertedTheme"
					[contact]="activeUser | await"
					[hideCurrentUser]="true"
					[showUnreadMessageCount]="true"
					*ngIf="
						(accountContactsSearch?.searchBar?.filterSingle
							| await) === undefined
					"
				></cyph-account-contact>
			</div>

			<div fxFlex>
				<div cyphNanoScroller>
					<div class="contact-list">
						<cyph-account-contact
							[startBurner]="true"
							[class.cyph-inverted-theme]="invertedTheme"
							*ngIf="!readOnly && !envService.isTelehealth"
						></cyph-account-contact>

						<cyph-account-contact
							[startGroup]="true"
							[class.cyph-inverted-theme]="invertedTheme"
							*ngIf="
								!readOnly &&
								(accountService.enableGroup | await)
							"
						></cyph-account-contact>

						<ng-container
							*ngFor="
								let item of filteredContactList | await;
								trackBy: trackByUser
							"
						>
							<ng-container
								*ngTemplateOutlet="
									listItem;
									context: {
										item: item
									}
								"
							></ng-container>
						</ng-container>
					</div>
				</div>
			</div>
		</ng-template>

		<br *ngIf="!readOnly" />

		<button
			mat-button
			class="add-contact"
			(click)="accountContactsService.addContactPrompt()"
			*ngIf="
				(accountDatabaseService.currentUser | await)?.agseConfirmed ===
					true && !readOnly
			"
		>
			<span>
				&nbsp;&nbsp;&nbsp;&nbsp;
				{{ stringsService.addContactTitle }}
				&nbsp;&nbsp;&nbsp;&nbsp;
			</span>
		</button>
		<mat-menu #addContactMenu="matMenu">
			<button
				mat-menu-item
				[matTooltip]="stringsService.addContactTooltipInternal"
				[matTooltipPosition]="
					(envService.isMobile | await) ? 'right' : 'left'
				"
				(click)="accountContactsService.addContactPrompt()"
			>
				{{ stringsService.addContactButtonInternal }}
			</button>
			<button
				disabled
				mat-menu-item
				[matTooltip]="stringsService.addContactTooltipExternal"
				[matTooltipPosition]="
					(envService.isMobile | await) ? 'right' : 'left'
				"
				(click)="
					accountContactsService.addContactPrompt(
						newContactTypes.external
					)
				"
			>
				{{ stringsService.addContactButtonExternal }}
			</button>
		</mat-menu>

		<br *ngIf="!readOnly" />
	</div>

	<mat-progress-spinner
		mode="indeterminate"
		*ngIf="
			(accountContactsService.showSpinner | await) ||
			(home && (accountFilesService.uploadSpinner | await) !== undefined)
		"
	></mat-progress-spinner>
</div>

<ng-template #listItem let-item="item">
	<cyph-account-contact
		[clickable]="!readOnly"
		[contact]="item"
		[hideCurrentUser]="true"
		[showUnreadMessageCount]="!readOnly"
		[class.cyph-inverted-theme]="invertedTheme"
	></cyph-account-contact>
</ng-template>
