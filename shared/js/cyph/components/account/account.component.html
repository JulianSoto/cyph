<div
	fxFlexFill
	fxLayout="row"
	fxLayout.xs="column"
	[class.mobile]="envService.isMobile | await"
	[class.transition]="accountService.transition | await"
>
	<div
		*ngIf="accountService.interstitial | await"
		class="interstitial animated fadeIn"
	>
		<div class="loading">
			<div class="logo-animation">
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
			</div>
		</div>
	</div>

	<canvas
		[fxShow]="envService.showGranim"
		class="cyph-gradient animated fadeIn"
	></canvas>

	<cyph-account-menu
		[fxFlex]="accountService.menuMaxWidth | await"
		fxHide.lt-md
		fxLayout="column"
		class="sidebar animated slideInLeft _0"
		*ngIf="menuVisible | await"
	>
		<button
			mat-icon-button
			cyphTranslate
			aria-label="Context Menu"
			[matMenuTriggerFor]="contextMenu"
		>
			<mat-icon>more_vert</mat-icon>
		</button>
	</cyph-account-menu>

	<div class="content" fxFlex fxFlexFill fxLayout="column" fxLayout.xs="row">
		<mat-sidenav-container
			fxFlexFill
			(backdropClick)="accountService.toggleMobileMenu(false)"
		>
			<mat-sidenav
				#sidenav
				ngClass.gt-sm="disabled"
				position="start"
				[opened]="accountService.mobileMenuOpen | await"
			>
				<cyph-account-menu [sidenav]="true"></cyph-account-menu>
			</mat-sidenav>

			<div fxFlexFill fxLayout="column">
				<div
					fxLayout="row"
					class="header slideInDown"
					[class.animated]="(envService.isMobile | await) === false"
					[class.fadeOutUp]="accountService.transition | await"
					fxLayoutAlign="stretch center"
					fxLayoutGap="8px"
					*ngIf="
						(accountService.header | await)?.header !== undefined &&
						(accountService.isCallActive | await) === false &&
						!(
							(envService.isMobile | await) &&
							(accountService.header | await)?.header?.desktop !==
								undefined &&
							(accountService.header | await)?.header?.mobile ===
								undefined
						) &&
						!(
							(envService.isMobile | await) === false &&
							(accountService.header | await)?.header?.desktop ===
								undefined &&
							(accountService.header | await)?.header?.mobile !==
								undefined
						)
					"
				>
					<div></div>

					<button
						mat-icon-button
						cyphTranslate
						class="logo-icon"
						aria-label="Menu"
						(click)="accountService.toggleMobileMenu()"
						fxHide.gt-sm
						*ngIf="
							(accountDatabaseService.currentUser | await) !==
								undefined &&
							(accountDatabaseService.currentUser | await)
								?.pseudoAccount === false
						"
					>
						<mat-icon
							[matBadge]="
								(
									((accountService.unreadMessages | await) ||
										0) +
									((accountFilesService.incomingFiles | await)
										?.length || 0)
								).toString()
							"
							[matBadgeHidden]="
								!(
									((accountService.unreadMessages | await) ||
										0) +
										((
											accountFilesService.incomingFiles
											| await
										)?.length || 0) >
									0
								)
							"
							matBadgePosition="above after"
						>
							menu
						</mat-icon>
					</button>

					<div></div>
					<div></div>
					<div></div>

					<div class="header-content" fxFlex fxLayout="row">
						<ng-container
							*ngIf="
								(accountService.header | await)
									?.header as header;
								else emptyHeader
							"
						>
							<a
								fxFlex
								class="profile-link"
								[routerLink]="
									'/profile/' + (header?.user?.username || '')
								"
								*ngIf="!!header?.user; else stringHeader"
							>
								<div
									fxFlex
									fxLayout="row"
									fxLayoutAlign="start center"
									fxLayoutGap="16px"
								>
									<img
										cyphTranslate
										class="avatar"
										[ngClass]="
											userPresence[
												(header?.user?.status
													| await) || 0
											]
										"
										alt="Profile Picture"
										[src]="
											(header?.user?.avatar | await) || ''
										"
									/>

									<h1
										*ngIf="
											header?.user?.name | await as name;
											else usernameHeader
										"
									>
										{{ name }}
									</h1>

									<ng-template #usernameHeader>
										<h1>
											@{{
												(header?.user?.realUsername
													| await) ||
													header?.user?.username ||
													''
											}}
										</h1>
									</ng-template>
								</div>
							</a>

							<ng-template #stringHeader>
								<h1 fxFlex>
									{{
										((envService.isMobile | await) ?
											header?.mobile :
											header?.desktop) || ''
									}}
								</h1>
							</ng-template>
						</ng-container>
						<ng-template #emptyHeader>
							<h1 fxFlex></h1>
						</ng-template>
					</div>

					<div></div>
					<div></div>
					<div></div>

					<!--
					<button
						mat-icon-button
						cyphTranslate
						aria-label='Search'
						routerLink='/search'
						fxHide.gt-sm
						*ngIf='!envService.isTelehealth'
					>
						<mat-icon>search</mat-icon>
					</button>
					-->

					<button
						mat-icon-button
						fxHide.gt-sm
						cyphTranslate
						aria-label="Context Menu"
						[matMenuTriggerFor]="contextMenu"
					>
						<mat-icon>more_vert</mat-icon>
					</button>

					<div></div>
				</div>

				<h3
					class="cyph-banner alert"
					cyphTranslate
					*ngIf="
						(accountService.accountGoodStanding | await) === false;
						else unverifiedAccountBanner
					"
				>
					We were unable to process your payment. Click
					<a
						cyphTranslate
						(click)="
							accountService.windowsAppUpgradeWorkaround($event, [
								envService.homeUrl,
								'checkout/#',
								configService.planConfig[
									accountSettingsService.plan.value ||
										cyphPlans.Free
								].checkoutPath || '',
								'/userToken=',
								accountService.getUserToken()
							])
						"
						>here</a
					>
					to update your payment details.
				</h3>

				<ng-template #unverifiedAccountBanner>
					<h3
						class="cyph-banner alert"
						cyphTranslate
						*ngIf="
							(accountDatabaseService.currentUser | await)
								?.agseConfirmed === false
						"
					>
						Your account is in queue to be verified and will be
						fully activated soon.
					</h3>
				</ng-template>

				<div
					fxFlex
					class="content-wrapper animated"
					[class.fadeOutUp]="accountService.transition | await"
					[class.full-height]="fullHeight | await"
					[class.padding]="(fullWidth | await) === false"
					[class.ui-disabled]="
						(accountService.accountGoodStanding | await) === false
					"
					ngClass.lt-md="small"
					ngClass.md="medium"
					ngClass.gt-md="large"
				>
					<router-outlet></router-outlet>
				</div>
			</div>
		</mat-sidenav-container>
	</div>

	<div
		[fxFlex]="accountService.menuExpandedMinWidthPX"
		[fxShow]="
			!envService.isTelehealth &&
			(accountDatabaseService.currentUser | await)?.agseConfirmed === true
		"
		fxLayout="column"
		class="sidebar contacts"
		*ngIf="sidebarVisible | await"
	>
		<div fxFlexFill fxLayout="row">
			<cyph-account-contacts
				fxFlex
				[sidebar]="true"
			></cyph-account-contacts>
		</div>
	</div>
</div>

<mat-menu #contextMenu="matMenu">
	<button
		mat-menu-item
		(click)="contextMenuActions.handler($event)"
		*ngFor="
			let contextMenuActions of (accountService.header | await)
				?.contextMenuActions | cyphArray;
			trackBy: trackBySelf
		"
	>
		<mat-icon>{{ contextMenuActions.icon }}</mat-icon>
		<span>{{ contextMenuActions.label }}</span>
	</button>

	<button mat-menu-item (click)="accountService.contactFormDialog('help')">
		<mat-icon>help</mat-icon>
		<span>{{ stringsService.contactSupport }}</span>
	</button>
	<button
		mat-menu-item
		(click)="accountService.contactFormDialog('feedback')"
	>
		<mat-icon>feedback</mat-icon>
		<span>{{ stringsService.feedback }}</span>
	</button>
	<button mat-menu-item (click)="screenshotService.saveScreenshot()">
		<mat-icon>fullscreen</mat-icon>
		<span>{{ stringsService.takeScreenshot }}</span>
	</button>
</mat-menu>
