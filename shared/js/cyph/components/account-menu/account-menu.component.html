<ng-container *ngIf="accountDatabaseService.currentUser | async as currentUser">
	<div
		fxFlexFill
		fxLayout="row"
		[class.collapsed]="(menuExpanded | async) === false"
		[class.menu]="!sidenav"
		[class.menu-root]="!sidenav"
		[class.mobile]="envService.isMobile | async"
		[class.sidenav]="sidenav"
	>
		<div fxFlex fxLayout="column" fxLayoutAlign="center stretch">
			<ng-container *ngTemplateOutlet="menuContent"></ng-container>
		</div>

		<button
			mat-button
			fxFlex="25px"
			fxHide.lt-md
			cyphTranslate
			class="menu-toggle"
			matTooltip="Toggle Menu"
			matTooltipPosition="right"
			(click)="accountService.toggleMenu()"
			*ngIf="accountService.menuExpandable | async"
		>
			<mat-icon [class.flipped]="(menuExpanded | async) === false">
				keyboard_arrow_left
			</mat-icon>
		</button>

		<div
			fxFlex="10px"
			*ngIf="
				!sidenav &&
				(accountService.menuExpandable | async) === false &&
				(accountService.menuReduced | async) === false
			"
		></div>
	</div>

	<ng-template #appointmentList>
		<mat-nav-list
			*ngIf="
				accountAppointmentsService.appointments.upcoming
					| async as upcomingAppointments
			"
		>
			<h3 matLine cyphTranslate class="upcoming-appointments">
				Upcoming Appointments
			</h3>

			<small>
				<div
					class="appointment-list-item"
					*ngFor="let o of upcomingAppointments"
				>
					<strong>{{ o.record.name }}</strong>
					<br />
					<small>
						{{
							getDateTimeString(
								o.appointment.calendarInvite.startTime
							)
						}}
						&ngsp; &ndash; &ngsp;
						{{
							getDateTimeString(
								o.appointment.calendarInvite.endTime
							)
						}}
					</small>
				</div>
			</small>
		</mat-nav-list>
	</ng-template>

	<ng-template #buttons>
		<mat-nav-list>
			<ng-container
				*ngIf="
					envService.isTelehealthFull &&
					(currentUser.user.userType | async) ===
						accountUserTypes.Standard &&
					(
						accountFilesService.incomingFilesFiltered.redoxPatients
						| async
					)?.length > 0
				"
			>
				<a
					mat-list-item
					cyphTranslate
					class="incoming-patient-info emphasis"
					[class.disabled]="
						!currentUser.agseConfirmed ||
						!currentUser.masterKeyConfirmed
					"
					aria-label="Incoming Patient Info"
					routerLink="/incoming-patient-info"
					(click)="click()"
				>
					<mat-icon
						mat-list-icon
						[matBadge]="
							(
								(
									accountFilesService.incomingFilesFiltered
										.redoxPatients | async
								)?.length || 0
							).toString()
						"
						[matBadgeHidden]="
							!(
								((
									accountFilesService.incomingFilesFiltered
										.redoxPatients | async
								)?.length || 0) > 0
							)
						"
						matBadgePosition="above after"
					>
						local_hospital
					</mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Incoming
					</h3>
				</a>
			</ng-container>

			<ng-container *ngIf="envService.isTelehealth">
				<a
					mat-list-item
					cyphTranslate
					class="appointments"
					[class.disabled]="
						!currentUser.agseConfirmed ||
						!currentUser.masterKeyConfirmed
					"
					aria-label="Appointments"
					routerLink="/appointments"
					(click)="click()"
				>
					<mat-icon
						mat-list-icon
						[matBadge]="
							(
								(
									accountFilesService.incomingFilesFiltered
										.appointments | async
								)?.length || 0
							).toString()
						"
						[matBadgeHidden]="
							!(
								((
									accountFilesService.incomingFilesFiltered
										.appointments | async
								)?.length || 0) > 0
							)
						"
						matBadgePosition="above after"
					>
						date_range
					</mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Appointments
					</h3>
				</a>
			</ng-container>

			<ng-container
				*ngIf="
					envService.isTelehealthFull &&
					(currentUser.user.userType | async) !==
						accountUserTypes.TelehealthDoctor
				"
			>
				<a
					mat-list-item
					cyphTranslate
					class="doctors"
					[class.disabled]="
						!currentUser.agseConfirmed ||
						!currentUser.masterKeyConfirmed
					"
					aria-label="Doctors"
					routerLink="/doctors"
					(click)="click()"
				>
					<mat-icon mat-list-icon svgIcon="doctor"></mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Doctors
					</h3>
				</a>
			</ng-container>

			<ng-container
				*ngIf="
					envService.isTelehealthFull &&
					(currentUser.user.userType | async) !==
						accountUserTypes.Standard
				"
			>
				<a
					mat-list-item
					cyphTranslate
					class="patients"
					[class.disabled]="
						!currentUser.agseConfirmed ||
						!currentUser.masterKeyConfirmed
					"
					aria-label="Patients"
					routerLink="/patients"
					(click)="click()"
				>
					<mat-icon mat-list-icon>local_hospital</mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Patients
					</h3>
				</a>

				<a
					mat-list-item
					cyphTranslate
					class="staff"
					[class.disabled]="
						!currentUser.agseConfirmed ||
						!currentUser.masterKeyConfirmed
					"
					aria-label="Staff"
					routerLink="/staff"
					(click)="click()"
				>
					<mat-icon mat-list-icon>people</mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Staff
					</h3>
				</a>

				<a
					mat-list-item
					cyphTranslate
					class="ehr-access"
					[class.disabled]="
						!currentUser.agseConfirmed ||
						!currentUser.masterKeyConfirmed
					"
					aria-label="EHR Access"
					routerLink="/ehr-access"
					(click)="click()"
				>
					<mat-icon mat-list-icon>vpn_key</mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						EHR Access
					</h3>
				</a>
			</ng-container>

			<ng-container *ngIf="!envService.isTelehealthFull">
				<a
					mat-list-item
					cyphTranslate
					class="contacts"
					[class.disabled]="
						!currentUser.agseConfirmed ||
						!currentUser.masterKeyConfirmed
					"
					aria-label="Messages"
					routerLink="/"
					(click)="click()"
				>
					<mat-icon
						mat-list-icon
						[matBadge]="
							(
								(accountService.unreadMessages | async) || 0
							).toString()
						"
						[matBadgeHidden]="
							!(
								((accountService.unreadMessages | async) || 0) >
								0
							)
						"
						matBadgePosition="above after"
					>
						message
					</mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Messages
					</h3>
				</a>

				<a
					mat-list-item
					cyphTranslate
					class="inbox"
					[class.disabled]="
						!currentUser.agseConfirmed ||
						!currentUser.masterKeyConfirmed
					"
					aria-label="Anonymous Inbox"
					routerLink="/inbox"
					(click)="click()"
				>
					<mat-icon
						mat-list-icon
						[matBadge]="
							(
								(
									accountFilesService.incomingFilesFiltered
										.notes
									| async
									| cyphFilter
										: accountFilesService.filterFunctions
												.anonymousMessages
								)?.length || 0
							).toString()
						"
						[matBadgeHidden]="
							!(
								((
									accountFilesService.incomingFilesFiltered
										.notes
									| async
									| cyphFilter
										: accountFilesService.filterFunctions
												.anonymousMessages
								)?.length || 0) > 0
							)
						"
						matBadgePosition="above after"
					>
						email
					</mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Anonymous Inbox
					</h3>
				</a>
			</ng-container>

			<ng-container
				*ngIf="
					!envService.isTelehealth ||
					(envService.isTelehealth &&
						(currentUser.user.userType | async) !==
							accountUserTypes.Standard)
				"
			>
				<a
					mat-list-item
					cyphTranslate
					class="files"
					[class.disabled]="!currentUser.masterKeyConfirmed"
					aria-label="Files"
					routerLink="/files"
					(click)="click()"
				>
					<mat-icon
						mat-list-icon
						[matBadge]="
							(
								(
									accountFilesService.incomingFilesFiltered
										.files | async
								)?.length || 0
							).toString()
						"
						[matBadgeHidden]="
							!(
								((
									accountFilesService.incomingFilesFiltered
										.files | async
								)?.length || 0) > 0
							)
						"
						matBadgePosition="above after"
					>
						folder
					</mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Files
					</h3>
				</a>

				<a
					mat-list-item
					cyphTranslate
					class="notes"
					[class.disabled]="!currentUser.masterKeyConfirmed"
					aria-label="Notes"
					routerLink="/notes"
					(click)="click()"
				>
					<mat-icon
						mat-list-icon
						[matBadge]="
							(
								(
									accountFilesService.incomingFilesFiltered
										.notes
									| async
									| cyphFilter
										: accountFilesService.filterFunctions
												.excludeAnonymousMessages
								)?.length || 0
							).toString()
						"
						[matBadgeHidden]="
							!(
								((
									accountFilesService.incomingFilesFiltered
										.notes
									| async
									| cyphFilter
										: accountFilesService.filterFunctions
												.excludeAnonymousMessages
								)?.length || 0) > 0
							)
						"
						matBadgePosition="above after"
					>
						create
					</mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Notes
					</h3>
				</a>

				<a
					mat-list-item
					cyphTranslate
					class="docs"
					[class.disabled]="!currentUser.masterKeyConfirmed"
					aria-label="Docs (experimental)"
					routerLink="/docs"
					(click)="click()"
					*ngIf="accountService.enableDocs | async"
				>
					<mat-icon
						mat-list-icon
						[matBadge]="
							(
								(
									accountFilesService.incomingFilesFiltered
										.docs | async
								)?.length || 0
							).toString()
						"
						[matBadgeHidden]="
							!(
								((
									accountFilesService.incomingFilesFiltered
										.docs | async
								)?.length || 0) > 0
							)
						"
						matBadgePosition="above after"
					>
						library_books
					</mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Docs (experimental)
					</h3>
				</a>

				<a
					mat-list-item
					cyphTranslate
					class="forms"
					[class.disabled]="!currentUser.masterKeyConfirmed"
					aria-label="Forms"
					routerLink="/forms"
					(click)="click()"
					*ngIf="envService.debug || envService.isTelehealthFull"
				>
					<mat-icon
						mat-list-icon
						[matBadge]="
							(
								(
									accountFilesService.incomingFilesFiltered
										.forms | async
								)?.length || 0
							).toString()
						"
						[matBadgeHidden]="
							!(
								((
									accountFilesService.incomingFilesFiltered
										.forms | async
								)?.length || 0) > 0
							)
						"
						matBadgePosition="above after"
						*ngIf="!envService.isTelehealth; else medicalFormsIcon"
					>
						content_paste
					</mat-icon>
					<ng-template #medicalFormsIcon>
						<mat-icon
							mat-list-icon
							[matBadge]="
								(
									(
										accountFilesService
											.incomingFilesFiltered.forms | async
									)?.length || 0
								).toString()
							"
							[matBadgeHidden]="
								!(
									((
										accountFilesService
											.incomingFilesFiltered.forms | async
									)?.length || 0) > 0
								)
							"
							matBadgePosition="above after"
							svgIcon="medical-forms"
						></mat-icon>
					</ng-template>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Forms
					</h3>
				</a>

				<a
					mat-list-item
					cyphTranslate
					class="passwords"
					[class.disabled]="!currentUser.masterKeyConfirmed"
					aria-label="Passwords"
					routerLink="/passwords"
					(click)="click()"
					*ngIf="accountService.enablePasswords | async"
				>
					<mat-icon
						mat-list-icon
						[matBadge]="
							(
								(
									accountFilesService.incomingFilesFiltered
										.passwords | async
								)?.length || 0
							).toString()
						"
						[matBadgeHidden]="
							!(
								((
									accountFilesService.incomingFilesFiltered
										.passwords | async
								)?.length || 0) > 0
							)
						"
						matBadgePosition="above after"
					>
						lock
					</mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Passwords
					</h3>
				</a>

				<a
					mat-list-item
					cyphTranslate
					class="wallets"
					[class.disabled]="!currentUser.masterKeyConfirmed"
					aria-label="Wallets (experimental)"
					routerLink="/wallets"
					(click)="click()"
					*ngIf="accountService.enableWallets | async"
				>
					<mat-icon
						mat-list-icon
						[matBadge]="
							(
								(
									accountFilesService.incomingFilesFiltered
										.wallets | async
								)?.length || 0
							).toString()
						"
						[matBadgeHidden]="
							!(
								((
									accountFilesService.incomingFilesFiltered
										.wallets | async
								)?.length || 0) > 0
							)
						"
						matBadgePosition="above after"
					>
						account_balance_wallet
					</mat-icon>
					<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
						Wallets (experimental)
					</h3>
				</a>
			</ng-container>
		</mat-nav-list>
	</ng-template>

	<ng-template #menuContent>
		<div fxFlex>
			<div cyphNanoScroller>
				<div fxFlex fxFlexFill>
					<div
						class="cover-image"
						[class.hidden]="envService.isTelehealth"
						[style.background-image]="
							urlToSafeStyle(currentUser.user.coverImage | async)
								| async
						"
						*ngIf="menuExpanded | async"
					></div>

					<div class="context-menu" *ngIf="menuExpanded | async">
						<ng-content></ng-content>
					</div>

					<mat-nav-list class="home-list">
						<a
							mat-list-item
							cyphTranslate
							class="home"
							aria-label="Home"
							routerLink="/profile"
							(click)="click()"
						>
							<cyph-logo
								mat-list-icon
								icon
								white
								*ngIf="(menuExpanded | async) === false"
							></cyph-logo>
							<cyph-logo
								matLine
								white
								*ngIf="menuExpanded | async"
							></cyph-logo>
						</a>
					</mat-nav-list>

					<mat-list class="avatar-list">
						<mat-list-item>
							<img
								cyphTranslate
								matListAvatar
								class="avatar"
								[ngClass]="
									userPresence[
										(currentUser.user.status | async) || 0
									]
								"
								alt="Profile Picture"
								[src]="currentUser.user.avatar | async"
								routerLink="/profile"
								(click)="click()"
							/>
							<h3 matLine [fxShow]="menuExpanded | async">
								{{ currentUser.user.name | async }}
							</h3>
							<div
								matLine
								[fxShow]="menuExpanded | async"
								fxLayoutAlign="row"
							>
								<div class="username">
									@{{ currentUser.user.realUsername | async }}
								</div>
								<mat-select
									cyphTranslate
									[ngModel]="currentUser.user.status | async"
									(ngModelChange)="
										currentUser.user.accountUserPresence.setValue(
											{status: $event}
										)
									"
									name="status"
									class="status"
									placeholder="Status"
									*ngIf="!envService.isTelehealth"
								>
									<mat-option
										*ngFor="
											let status of statuses;
											trackBy: trackByValue
										"
										[value]="status.value"
									>
										{{ status.text }}
									</mat-option>
								</mat-select>
							</div>
						</mat-list-item>
					</mat-list>

					<ng-container
						*ngTemplateOutlet="
							envService.isTelehealth &&
							!envService.isTelehealthFull ?
								appointmentList :
								buttons
						"
					></ng-container>
				</div>
			</div>
		</div>

		<mat-nav-list>
			<mat-divider></mat-divider>

			<a
				mat-list-item
				cyphTranslate
				class="invite"
				[matMenuTriggerFor]="inviteMenu"
				aria-label="Invite Friend"
				*ngIf="((accountInviteService.count | async) || 0) > 0"
			>
				<mat-icon
					mat-list-icon
					[matBadge]="
						((accountInviteService.count | async) || 0).toString()
					"
					matBadgePosition="above after"
				>
					person_add
				</mat-icon>
				<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
					Invite Friend
				</h3>
			</a>
			<mat-menu #inviteMenu="matMenu">
				<button
					mat-menu-item
					[matTooltip]="stringsService.addContactTooltipInvite"
					matTooltipPosition="right"
					(click)="
						click();
						accountContactsService.addContactPrompt(
							newContactTypes.invite
						)
					"
					*ngIf="((accountInviteService.count | async) || 0) > 0"
				>
					{{ stringsService.addContactButtonInviteEmail }}
				</button>
				<button
					mat-menu-item
					[matTooltip]="stringsService.addContactTooltipInviteLink"
					matTooltipPosition="right"
					(click)="click(); accountInviteService.showInviteURL()"
					*ngIf="((accountInviteService.count | async) || 0) > 0"
				>
					{{ stringsService.inviteLinkButton }}
				</button>
			</mat-menu>

			<a
				mat-list-item
				cyphTranslate
				class="settings"
				[class.disabled]="!currentUser.masterKeyConfirmed"
				aria-label="Settings"
				routerLink="/settings"
				(click)="click()"
			>
				<mat-icon mat-list-icon>settings</mat-icon>
				<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
					Settings
				</h3>
			</a>

			<a
				mat-list-item
				cyphTranslate
				class="lock"
				[class.disabled]="!currentUser.masterKeyConfirmed"
				aria-label="Lock"
				(click)="accountAuthService.lock()"
			>
				<mat-icon mat-list-icon>lock</mat-icon>
				<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
					Lock
				</h3>
			</a>

			<a
				mat-list-item
				cyphTranslate
				class="logout"
				[class.disabled]="!currentUser.masterKeyConfirmed"
				aria-label="Log Out"
				routerLink="/logout"
				(click)="click()"
			>
				<mat-icon mat-list-icon>exit_to_app</mat-icon>
				<h3 matLine cyphTranslate *ngIf="menuExpanded | async">
					Log Out
				</h3>
			</a>
		</mat-nav-list>
	</ng-template>
</ng-container>
